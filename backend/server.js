// const express = require('express');
// const http = require('http');
// const { Server } = require('socket.io');

// const app = express();
// const server = http.createServer(app);
// const io = new Server(server);

// app.use(express.static('public'));

// // Example bus routes
// const busRoutes = [
//   {
//     id: 1,
//     name: "Bus 1",
//     coords: [
//       [
//         22.579749,
//         88.428817
//       ],
//       [
//         22.579753,
//         88.428813
//       ],
//       [
//         22.580164,
//         88.428489
//       ],
//       [
//         22.579688,
//         88.427669
//       ],
//       [
//         22.579338,
//         88.427064
//       ],
//       [
//         22.579046,
//         88.426599
//       ],
//       [
//         22.578988,
//         88.426504
//       ],
//       [
//         22.57921,
//         88.426352
//       ],
//       [
//         22.579291,
//         88.426297
//       ],
//       [
//         22.579631,
//         88.426081
//       ],
//       [
//         22.579872,
//         88.425882
//       ],
//       [
//         22.580964,
//         88.42512
//       ],
//       [
//         22.58122,
//         88.42494
//       ],
//       [
//         22.582072,
//         88.424373
//       ],
//       [
//         22.582509,
//         88.424072
//       ],
//       [
//         22.582477,
//         88.424021
//       ],
//       [
//         22.582522,
//         88.423989
//       ],
//       [
//         22.58255,
//         88.424035
//       ],
//       [
//         22.583662,
//         88.423269
//       ],
//       [
//         22.585412,
//         88.422062
//       ],
//       [
//         22.584478,
//         88.420475
//       ],
//       [
//         22.583568,
//         88.418922
//       ],
//       [
//         22.583478,
//         88.418924
//       ],
//       [
//         22.583424,
//         88.418897
//       ],
//       [
//         22.583378,
//         88.418872
//       ],
//       [
//         22.583319,
//         88.418812
//       ],
//       [
//         22.583313,
//         88.418788
//       ],
//       [
//         22.583293,
//         88.418739
//       ],
//       [
//         22.583286,
//         88.418651
//       ],
//       [
//         22.583303,
//         88.418568
//       ],
//       [
//         22.583838,
//         88.416043
//       ],
//       [
//         22.583903,
//         88.415659
//       ],
//       [
//         22.583903,
//         88.415577
//       ],
//       [
//         22.583876,
//         88.415499
//       ],
//       [
//         22.583849,
//         88.415451
//       ],
//       [
//         22.583846,
//         88.415366
//       ],
//       [
//         22.583884,
//         88.415253
//       ],
//       [
//         22.583954,
//         88.415213
//       ],
//       [
//         22.584042,
//         88.415128
//       ],
//       [
//         22.584111,
//         88.414989
//       ],
//       [
//         22.584178,
//         88.414684
//       ],
//       [
//         22.58442,
//         88.413494
//       ],
//       [
//         22.584505,
//         88.413076
//       ],
//       [
//         22.584667,
//         88.412141
//       ],
//       [
//         22.584702,
//         88.411996
//       ],
//       [
//         22.584685,
//         88.411953
//       ],
//       [
//         22.584689,
//         88.411861
//       ],
//       [
//         22.584725,
//         88.411793
//       ],
//       [
//         22.584772,
//         88.41176
//       ],
//       [
//         22.584832,
//         88.411745
//       ],
//       [
//         22.58492,
//         88.411777
//       ],
//       [
//         22.584965,
//         88.411827
//       ],
//       [
//         22.584982,
//         88.41188
//       ],
//       [
//         22.584985,
//         88.411931
//       ],
//       [
//         22.58495,
//         88.412023
//       ],
//       [
//         22.584892,
//         88.412063
//       ],
//       [
//         22.584836,
//         88.412076
//       ],
//       [
//         22.584638,
//         88.412954
//       ],
//       [
//         22.584511,
//         88.413517
//       ],
//       [
//         22.58442,
//         88.413494
//       ],
//       [
//         22.584505,
//         88.413076
//       ],
//       [
//         22.584667,
//         88.412141
//       ],
//       [
//         22.584702,
//         88.411996
//       ],
//       [
//         22.584685,
//         88.411953
//       ],
//       [
//         22.584689,
//         88.411861
//       ],
//       [
//         22.584314,
//         88.411226
//       ],
//       [
//         22.583853,
//         88.410449
//       ],
//       [
//         22.583405,
//         88.409678
//       ],
//       [
//         22.583178,
//         88.409286
//       ],
//       [
//         22.583116,
//         88.409157
//       ],
//       [
//         22.582419,
//         88.407996
//       ],
//       [
//         22.581605,
//         88.406613
//       ],
//       [
//         22.581537,
//         88.406608
//       ],
//       [
//         22.581501,
//         88.406587
//       ],
//       [
//         22.581455,
//         88.406537
//       ],
//       [
//         22.581438,
//         88.406489
//       ],
//       [
//         22.581434,
//         88.406436
//       ],
//       [
//         22.581462,
//         88.406359
//       ],
//       [
//         22.580979,
//         88.405554
//       ],
//       [
//         22.580959,
//         88.405461
//       ],
//       [
//         22.58092,
//         88.405279
//       ],
//       [
//         22.580855,
//         88.405096
//       ],
//       [
//         22.580816,
//         88.404929
//       ],
//       [
//         22.580777,
//         88.404663
//       ],
//       [
//         22.580786,
//         88.404126
//       ],
//       [
//         22.580779,
//         88.40375
//       ],
//       [
//         22.580777,
//         88.403695
//       ],
//       [
//         22.580778,
//         88.403394
//       ],
//       [
//         22.580779,
//         88.403118
//       ],
//       [
//         22.58074,
//         88.402629
//       ],
//       [
//         22.580708,
//         88.402379
//       ],
//       [
//         22.580639,
//         88.40199
//       ],
//       [
//         22.580656,
//         88.401822
//       ],
//       [
//         22.580713,
//         88.401564
//       ],
//       [
//         22.580683,
//         88.401332
//       ],
//       [
//         22.580692,
//         88.401275
//       ],
//       [
//         22.58073,
//         88.40119
//       ],
//       [
//         22.580745,
//         88.401046
//       ],
//       [
//         22.580737,
//         88.400974
//       ],
//       [
//         22.580682,
//         88.400837
//       ],
//       [
//         22.580608,
//         88.400712
//       ],
//       [
//         22.580347,
//         88.400811
//       ],
//       [
//         22.580158,
//         88.400915
//       ],
//       [
//         22.580004,
//         88.400969
//       ],
//       [
//         22.57967,
//         88.40106
//       ],
//       [
//         22.578342,
//         88.401366
//       ],
//       [
//         22.578036,
//         88.401467
//       ],
//       [
//         22.577961,
//         88.401492
//       ],
//       [
//         22.57757,
//         88.401616
//       ],
//       [
//         22.577139,
//         88.401733
//       ],
//       [
//         22.57684,
//         88.401794
//       ],
//       [
//         22.576482,
//         88.40187
//       ],
//       [
//         22.576035,
//         88.401991
//       ],
//       [
//         22.574741,
//         88.402361
//       ],
//       [
//         22.574362,
//         88.402457
//       ],
//       [
//         22.574261,
//         88.4025
//       ],
//       [
//         22.572381,
//         88.403088
//       ],
//       [
//         22.571507,
//         88.40348
//       ],
//       [
//         22.571144,
//         88.403643
//       ],
//       [
//         22.570867,
//         88.403756
//       ],
//       [
//         22.570728,
//         88.403804
//       ],
//       [
//         22.570775,
//         88.403962
//       ],
//       [
//         22.571016,
//         88.403839
//       ],
//       [
//         22.571142,
//         88.403782
//       ],
//       [
//         22.5712,
//         88.403963
//       ],
//       [
//         22.57121,
//         88.404015
//       ],
//       [
//         22.571566,
//         88.404918
//       ],
//       [
//         22.571742,
//         88.405367
//       ],
//       [
//         22.57191,
//         88.405822
//       ],
//       [
//         22.572002,
//         88.406125
//       ],
//       [
//         22.57208,
//         88.4065
//       ],
//       [
//         22.5721,
//         88.406669
//       ],
//       [
//         22.572102,
//         88.407082
//       ],
//       [
//         22.572073,
//         88.407333
//       ],
//       [
//         22.571854,
//         88.408351
//       ],
//       [
//         22.571863,
//         88.408379
//       ],
//       [
//         22.571838,
//         88.40846
//       ],
//       [
//         22.571818,
//         88.408482
//       ],
//       [
//         22.571749,
//         88.408752
//       ],
//       [
//         22.57166,
//         88.409124
//       ],
//       [
//         22.57156,
//         88.409543
//       ],
//       [
//         22.571197,
//         88.411058
//       ],
//       [
//         22.571131,
//         88.411349
//       ],
//       [
//         22.57156,
//         88.411461
//       ],
//       [
//         22.571966,
//         88.411557
//       ],
//       [
//         22.572354,
//         88.411674
//       ],
//       [
//         22.572725,
//         88.411773
//       ],
//       [
//         22.572812,
//         88.411407
//       ],
//       [
//         22.573229,
//         88.411503
//       ],
//       [
//         22.573305,
//         88.411174
//       ],
//       [
//         22.573229,
//         88.411503
//       ],
//       [
//         22.57364,
//         88.411615
//       ],
//       [
//         22.574007,
//         88.411718
//       ],
//       [
//         22.574076,
//         88.411431
//       ],
//       [
//         22.574167,
//         88.411462
//       ],
//       [
//         22.574006,
//         88.412151
//       ],
//       [
//         22.57391,
//         88.41256
//       ],
//       [
//         22.573888,
//         88.412654
//       ],
//       [
//         22.573949,
//         88.412707
//       ],
//       [
//         22.573982,
//         88.412774
//       ],
//       [
//         22.57399,
//         88.412833
//       ],
//       [
//         22.573981,
//         88.412917
//       ],
//       [
//         22.573954,
//         88.412968
//       ],
//       [
//         22.573892,
//         88.413032
//       ],
//       [
//         22.573793,
//         88.413058
//       ],
//       [
//         22.573677,
//         88.413546
//       ],
//       [
//         22.573432,
//         88.414581
//       ],
//       [
//         22.573258,
//         88.415319
//       ],
//       [
//         22.572892,
//         88.416869
//       ],
//       [
//         22.572918,
//         88.4169
//       ],
//       [
//         22.572934,
//         88.416956
//       ],
//       [
//         22.572923,
//         88.417023
//       ],
//       [
//         22.5729,
//         88.417053
//       ],
//       [
//         22.572841,
//         88.417086
//       ],
//       [
//         22.571915,
//         88.419747
//       ],
//       [
//         22.572451,
//         88.420025
//       ],
//       [
//         22.574529,
//         88.421118
//       ],
//       [
//         22.574628,
//         88.421174
//       ],
//       [
//         22.574601,
//         88.421248
//       ],
//       [
//         22.574472,
//         88.421543
//       ],
//       [
//         22.574482,
//         88.42166
//       ],
//       [
//         22.57455,
//         88.421731
//       ],
//       [
//         22.576253,
//         88.422627
//       ],
//       [
//         22.576992,
//         88.423011
//       ],
//       [
//         22.577171,
//         88.423147
//       ],
//       [
//         22.577309,
//         88.423283
//       ],
//       [
//         22.577386,
//         88.423381
//       ],
//       [
//         22.57753,
//         88.423539
//       ],
//       [
//         22.577783,
//         88.423939
//       ],
//       [
//         22.57921,
//         88.426352
//       ],
//       [
//         22.579265,
//         88.426452
//       ],
//       [
//         22.579046,
//         88.426599
//       ],
//       [
//         22.578301,
//         88.4271
//       ],
//       [
//         22.578031,
//         88.427336
//       ],
//       [
//         22.57781,
//         88.427558
//       ],
//       [
//         22.577502,
//         88.427941
//       ],
//       [
//         22.577279,
//         88.428328
//       ],
//       [
//         22.576887,
//         88.429182
//       ],
//       [
//         22.576843,
//         88.429288
//       ],
//       [
//         22.576693,
//         88.42962
//       ],
//       [
//         22.576368,
//         88.430342
//       ],
//       [
//         22.576299,
//         88.430501
//       ],
//       [
//         22.575473,
//         88.432317
//       ],
//       [
//         22.575405,
//         88.432466
//       ],
//       [
//         22.575136,
//         88.433031
//       ],
//       [
//         22.574824,
//         88.433729
//       ],
//       [
//         22.574786,
//         88.43383
//       ],
//       [
//         22.574215,
//         88.435113
//       ],
//       [
//         22.573609,
//         88.436408
//       ],
//       [
//         22.573266,
//         88.437181
//       ],
//       [
//         22.573132,
//         88.437463
//       ],
//       [
//         22.572756,
//         88.438288
//       ],
//       [
//         22.572681,
//         88.438241
//       ],
//       [
//         22.572586,
//         88.438103
//       ],
//       [
//         22.572527,
//         88.438042
//       ],
//       [
//         22.571822,
//         88.437602
//       ],
//       [
//         22.571402,
//         88.437439
//       ],
//       [
//         22.570119,
//         88.436993
//       ],
//       [
//         22.568349,
//         88.436503
//       ],
//       [
//         22.56725,
//         88.436248
//       ],
//       [
//         22.567204,
//         88.436125
//       ],
//       [
//         22.567215,
//         88.435932
//       ],
//       [
//         22.567202,
//         88.43585
//       ],
//       [
//         22.567226,
//         88.435745
//       ],
//       [
//         22.567024,
//         88.435685
//       ],
//       [
//         22.56693,
//         88.435637
//       ],
//       [
//         22.56686,
//         88.435575
//       ],
//       [
//         22.566798,
//         88.435479
//       ],
//       [
//         22.566714,
//         88.435237
//       ],
//       [
//         22.566595,
//         88.435133
//       ],
//       [
//         22.566533,
//         88.435114
//       ],
//       [
//         22.566476,
//         88.435148
//       ],
//       [
//         22.566432,
//         88.4352
//       ],
//       [
//         22.566268,
//         88.435594
//       ],
//       [
//         22.566152,
//         88.43579
//       ],
//       [
//         22.566085,
//         88.435825
//       ],
//       [
//         22.565941,
//         88.435774
//       ],
//       [
//         22.565431,
//         88.435696
//       ],
//       [
//         22.56524,
//         88.435682
//       ],
//       [
//         22.564376,
//         88.435457
//       ],
//       [
//         22.563266,
//         88.435017
//       ],
//       [
//         22.562852,
//         88.434869
//       ],
//       [
//         22.562753,
//         88.434816
//       ]
//     ],
//     speed: 0.1,
//     index: 0,
//     distanceCovered: 0,
//   },
//   {
//     id: 2,
//     name: "Bus 2",
//     coords: [
//       [22.5728, 88.3637],
//       [22.5735, 88.3642],
//       [22.5745, 88.3650],
//       [22.5755, 88.3660],
//       [22.5765, 88.3670]
//     ],
//     speed: 0.00008,
//     index: 0,
//     distanceCovered: 0,
//   },
// ];

// // Haversine distance
// function getDistance([lat1, lon1], [lat2, lon2]) {
//   const R = 6371e3;
//   const φ1 = lat1 * Math.PI / 180;
//   const φ2 = lat2 * Math.PI / 180;
//   const Δφ = (lat2 - lat1) * Math.PI / 180;
//   const Δλ = (lon2 - lon1) * Math.PI / 180;

//   const a = Math.sin(Δφ / 2) ** 2 +
//     Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) ** 2;
//   const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
//   return R * c;
// }

// // Move buses
// function moveBuses() {
//   busRoutes.forEach(bus => {
//     const current = bus.coords[bus.index];
//     const next = bus.coords[bus.index + 1];

//     if (next) {
//       const latDiff = next[0] - current[0];
//       const lonDiff = next[1] - current[1];
//       const distance = getDistance(current, next);

//       const stepLat = (latDiff / distance) * bus.speed * 1000;
//       const stepLon = (lonDiff / distance) * bus.speed * 1000;

//       bus.coords[bus.index][0] += stepLat;
//       bus.coords[bus.index][1] += stepLon;
//       bus.distanceCovered += getDistance(current, [current[0] + stepLat, current[1] + stepLon]);

//       if (getDistance(current, next) < 2) {
//         bus.index++;
//       }
//     }
//   });
//   // server logs
//   console.log("Emitting buses:", JSON.stringify(busRoutes.map(bus => ({
//     id: bus.name,
//     lat: bus.coords[bus.index]?.[0],
//     lon: bus.coords[bus.index]?.[1]
//   }))));
//   //
//   // Emit as object keyed by bus name
//   io.emit(
//     'busUpdate',
//     Object.fromEntries(
//       busRoutes.map(bus => [
//         bus.name,
//         {
//           lat: bus.coords[bus.index]?.[0] || bus.coords[bus.coords.length - 1][0],
//           lon: bus.coords[bus.index]?.[1] || bus.coords[bus.coords.length - 1][1],
//           speed: bus.speed,
//           distance: bus.distanceCovered
//         }
//       ])
//     )
//   );
// }

// setInterval(moveBuses, 1000);

// server.listen(3000, () => console.log('Server running on port 3000'));
const express = require('express');
const http = require('http');
const { Server } = require('socket.io');

const app = express();
const server = http.createServer(app);
const io = new Server(server);

app.use(express.static('public'));

// Bus routes
const busRoutes = [
  {
    id: 1,
    name: "Sector V-Rajarhat Route",
    coords: [
      [
        22.579749,
        88.428817
      ],
      [
        22.579753,
        88.428813
      ],
      [
        22.580164,
        88.428489
      ],
      [
        22.579688,
        88.427669
      ],
      [
        22.579338,
        88.427064
      ],
      [
        22.579046,
        88.426599
      ],
      [
        22.578988,
        88.426504
      ],
      [
        22.57921,
        88.426352
      ],
      [
        22.579291,
        88.426297
      ],
      [
        22.579631,
        88.426081
      ],
      [
        22.579872,
        88.425882
      ],
      [
        22.580964,
        88.42512
      ],
      [
        22.58122,
        88.42494
      ],
      [
        22.582072,
        88.424373
      ],
      [
        22.582509,
        88.424072
      ],
      [
        22.582477,
        88.424021
      ],
      [
        22.582522,
        88.423989
      ],
      [
        22.58255,
        88.424035
      ],
      [
        22.583662,
        88.423269
      ],
      [
        22.585412,
        88.422062
      ],
      [
        22.584478,
        88.420475
      ],
      [
        22.583568,
        88.418922
      ],
      [
        22.583478,
        88.418924
      ],
      [
        22.583424,
        88.418897
      ],
      [
        22.583378,
        88.418872
      ],
      [
        22.583319,
        88.418812
      ],
      [
        22.583313,
        88.418788
      ],
      [
        22.583293,
        88.418739
      ],
      [
        22.583286,
        88.418651
      ],
      [
        22.583303,
        88.418568
      ],
      [
        22.583838,
        88.416043
      ],
      [
        22.583903,
        88.415659
      ],
      [
        22.583903,
        88.415577
      ],
      [
        22.583876,
        88.415499
      ],
      [
        22.583849,
        88.415451
      ],
      [
        22.583846,
        88.415366
      ],
      [
        22.583884,
        88.415253
      ],
      [
        22.583954,
        88.415213
      ],
      [
        22.584042,
        88.415128
      ],
      [
        22.584111,
        88.414989
      ],
      [
        22.584178,
        88.414684
      ],
      [
        22.58442,
        88.413494
      ],
      [
        22.584505,
        88.413076
      ],
      [
        22.584667,
        88.412141
      ],
      [
        22.584702,
        88.411996
      ],
      [
        22.584685,
        88.411953
      ],
      [
        22.584689,
        88.411861
      ],
      [
        22.584725,
        88.411793
      ],
      [
        22.584772,
        88.41176
      ],
      [
        22.584832,
        88.411745
      ],
      [
        22.58492,
        88.411777
      ],
      [
        22.584965,
        88.411827
      ],
      [
        22.584982,
        88.41188
      ],
      [
        22.584985,
        88.411931
      ],
      [
        22.58495,
        88.412023
      ],
      [
        22.584892,
        88.412063
      ],
      [
        22.584836,
        88.412076
      ],
      [
        22.584638,
        88.412954
      ],
      [
        22.584511,
        88.413517
      ],
      [
        22.58442,
        88.413494
      ],
      [
        22.584505,
        88.413076
      ],
      [
        22.584667,
        88.412141
      ],
      [
        22.584702,
        88.411996
      ],
      [
        22.584685,
        88.411953
      ],
      [
        22.584689,
        88.411861
      ],
      [
        22.584314,
        88.411226
      ],
      [
        22.583853,
        88.410449
      ],
      [
        22.583405,
        88.409678
      ],
      [
        22.583178,
        88.409286
      ],
      [
        22.583116,
        88.409157
      ],
      [
        22.582419,
        88.407996
      ],
      [
        22.581605,
        88.406613
      ],
      [
        22.581537,
        88.406608
      ],
      [
        22.581501,
        88.406587
      ],
      [
        22.581455,
        88.406537
      ],
      [
        22.581438,
        88.406489
      ],
      [
        22.581434,
        88.406436
      ],
      [
        22.581462,
        88.406359
      ],
      [
        22.580979,
        88.405554
      ],
      [
        22.580959,
        88.405461
      ],
      [
        22.58092,
        88.405279
      ],
      [
        22.580855,
        88.405096
      ],
      [
        22.580816,
        88.404929
      ],
      [
        22.580777,
        88.404663
      ],
      [
        22.580786,
        88.404126
      ],
      [
        22.580779,
        88.40375
      ],
      [
        22.580777,
        88.403695
      ],
      [
        22.580778,
        88.403394
      ],
      [
        22.580779,
        88.403118
      ],
      [
        22.58074,
        88.402629
      ],
      [
        22.580708,
        88.402379
      ],
      [
        22.580639,
        88.40199
      ],
      [
        22.580656,
        88.401822
      ],
      [
        22.580713,
        88.401564
      ],
      [
        22.580683,
        88.401332
      ],
      [
        22.580692,
        88.401275
      ],
      [
        22.58073,
        88.40119
      ],
      [
        22.580745,
        88.401046
      ],
      [
        22.580737,
        88.400974
      ],
      [
        22.580682,
        88.400837
      ],
      [
        22.580608,
        88.400712
      ],
      [
        22.580347,
        88.400811
      ],
      [
        22.580158,
        88.400915
      ],
      [
        22.580004,
        88.400969
      ],
      [
        22.57967,
        88.40106
      ],
      [
        22.578342,
        88.401366
      ],
      [
        22.578036,
        88.401467
      ],
      [
        22.577961,
        88.401492
      ],
      [
        22.57757,
        88.401616
      ],
      [
        22.577139,
        88.401733
      ],
      [
        22.57684,
        88.401794
      ],
      [
        22.576482,
        88.40187
      ],
      [
        22.576035,
        88.401991
      ],
      [
        22.574741,
        88.402361
      ],
      [
        22.574362,
        88.402457
      ],
      [
        22.574261,
        88.4025
      ],
      [
        22.572381,
        88.403088
      ],
      [
        22.571507,
        88.40348
      ],
      [
        22.571144,
        88.403643
      ],
      [
        22.570867,
        88.403756
      ],
      [
        22.570728,
        88.403804
      ],
      [
        22.570775,
        88.403962
      ],
      [
        22.571016,
        88.403839
      ],
      [
        22.571142,
        88.403782
      ],
      [
        22.5712,
        88.403963
      ],
      [
        22.57121,
        88.404015
      ],
      [
        22.571566,
        88.404918
      ],
      [
        22.571742,
        88.405367
      ],
      [
        22.57191,
        88.405822
      ],
      [
        22.572002,
        88.406125
      ],
      [
        22.57208,
        88.4065
      ],
      [
        22.5721,
        88.406669
      ],
      [
        22.572102,
        88.407082
      ],
      [
        22.572073,
        88.407333
      ],
      [
        22.571854,
        88.408351
      ],
      [
        22.571863,
        88.408379
      ],
      [
        22.571838,
        88.40846
      ],
      [
        22.571818,
        88.408482
      ],
      [
        22.571749,
        88.408752
      ],
      [
        22.57166,
        88.409124
      ],
      [
        22.57156,
        88.409543
      ],
      [
        22.571197,
        88.411058
      ],
      [
        22.571131,
        88.411349
      ],
      [
        22.57156,
        88.411461
      ],
      [
        22.571966,
        88.411557
      ],
      [
        22.572354,
        88.411674
      ],
      [
        22.572725,
        88.411773
      ],
      [
        22.572812,
        88.411407
      ],
      [
        22.573229,
        88.411503
      ],
      [
        22.573305,
        88.411174
      ],
      [
        22.573229,
        88.411503
      ],
      [
        22.57364,
        88.411615
      ],
      [
        22.574007,
        88.411718
      ],
      [
        22.574076,
        88.411431
      ],
      [
        22.574167,
        88.411462
      ],
      [
        22.574006,
        88.412151
      ],
      [
        22.57391,
        88.41256
      ],
      [
        22.573888,
        88.412654
      ],
      [
        22.573949,
        88.412707
      ],
      [
        22.573982,
        88.412774
      ],
      [
        22.57399,
        88.412833
      ],
      [
        22.573981,
        88.412917
      ],
      [
        22.573954,
        88.412968
      ],
      [
        22.573892,
        88.413032
      ],
      [
        22.573793,
        88.413058
      ],
      [
        22.573677,
        88.413546
      ],
      [
        22.573432,
        88.414581
      ],
      [
        22.573258,
        88.415319
      ],
      [
        22.572892,
        88.416869
      ],
      [
        22.572918,
        88.4169
      ],
      [
        22.572934,
        88.416956
      ],
      [
        22.572923,
        88.417023
      ],
      [
        22.5729,
        88.417053
      ],
      [
        22.572841,
        88.417086
      ],
      [
        22.571915,
        88.419747
      ],
      [
        22.572451,
        88.420025
      ],
      [
        22.574529,
        88.421118
      ],
      [
        22.574628,
        88.421174
      ],
      [
        22.574601,
        88.421248
      ],
      [
        22.574472,
        88.421543
      ],
      [
        22.574482,
        88.42166
      ],
      [
        22.57455,
        88.421731
      ],
      [
        22.576253,
        88.422627
      ],
      [
        22.576992,
        88.423011
      ],
      [
        22.577171,
        88.423147
      ],
      [
        22.577309,
        88.423283
      ],
      [
        22.577386,
        88.423381
      ],
      [
        22.57753,
        88.423539
      ],
      [
        22.577783,
        88.423939
      ],
      [
        22.57921,
        88.426352
      ],
      [
        22.579265,
        88.426452
      ],
      [
        22.579046,
        88.426599
      ],
      [
        22.578301,
        88.4271
      ],
      [
        22.578031,
        88.427336
      ],
      [
        22.57781,
        88.427558
      ],
      [
        22.577502,
        88.427941
      ],
      [
        22.577279,
        88.428328
      ],
      [
        22.576887,
        88.429182
      ],
      [
        22.576843,
        88.429288
      ],
      [
        22.576693,
        88.42962
      ],
      [
        22.576368,
        88.430342
      ],
      [
        22.576299,
        88.430501
      ],
      [
        22.575473,
        88.432317
      ],
      [
        22.575405,
        88.432466
      ],
      [
        22.575136,
        88.433031
      ],
      [
        22.574824,
        88.433729
      ],
      [
        22.574786,
        88.43383
      ],
      [
        22.574215,
        88.435113
      ],
      [
        22.573609,
        88.436408
      ],
      [
        22.573266,
        88.437181
      ],
      [
        22.573132,
        88.437463
      ],
      [
        22.572756,
        88.438288
      ],
      [
        22.572681,
        88.438241
      ],
      [
        22.572586,
        88.438103
      ],
      [
        22.572527,
        88.438042
      ],
      [
        22.571822,
        88.437602
      ],
      [
        22.571402,
        88.437439
      ],
      [
        22.570119,
        88.436993
      ],
      [
        22.568349,
        88.436503
      ],
      [
        22.56725,
        88.436248
      ],
      [
        22.567204,
        88.436125
      ],
      [
        22.567215,
        88.435932
      ],
      [
        22.567202,
        88.43585
      ],
      [
        22.567226,
        88.435745
      ],
      [
        22.567024,
        88.435685
      ],
      [
        22.56693,
        88.435637
      ],
      [
        22.56686,
        88.435575
      ],
      [
        22.566798,
        88.435479
      ],
      [
        22.566714,
        88.435237
      ],
      [
        22.566595,
        88.435133
      ],
      [
        22.566533,
        88.435114
      ],
      [
        22.566476,
        88.435148
      ],
      [
        22.566432,
        88.4352
      ],
      [
        22.566268,
        88.435594
      ],
      [
        22.566152,
        88.43579
      ],
      [
        22.566085,
        88.435825
      ],
      [
        22.565941,
        88.435774
      ],
      [
        22.565431,
        88.435696
      ],
      [
        22.56524,
        88.435682
      ],
      [
        22.564376,
        88.435457
      ],
      [
        22.563266,
        88.435017
      ],
      [
        22.562852,
        88.434869
      ],
      [
        22.562753,
        88.434816
      ]
    ],
    speed: 20, // meters per second
    index: 0,
    distanceCovered: 0,
    current: null
  },
  {
    id: 2,
    name: "NewTown-Howrah Route",
    coords:  [[  22.595904,
    88.380014
  ],
  [
    22.596104,
    88.380021
  ],
  [
    22.596988,
    88.379811
  ],
  [
    22.597689,
    88.379645
  ],
  [
    22.59775,
    88.379619
  ],
  [
    22.597994,
    88.379512
  ],
  [
    22.599611,
    88.378819
  ],
  [
    22.601215,
    88.377918
  ],
  [
    22.602386,
    88.376992
  ],
  [
    22.602863,
    88.376628
  ],
  [
    22.602919,
    88.376586
  ],
  [
    22.602951,
    88.376668
  ],
  [
    22.603134,
    88.377234
  ],
  [
    22.603161,
    88.377317
  ],
  [
    22.603247,
    88.377635
  ],
  [
    22.603527,
    88.378459
  ],
  [
    22.603715,
    88.379114
  ],
  [
    22.603758,
    88.379274
  ],
  [
    22.604453,
    88.381265
  ],
  [
    22.605135,
    88.383523
  ],
  [
    22.605238,
    88.383866
  ],
  [
    22.605296,
    88.384036
  ],
  [
    22.605433,
    88.384506
  ],
  [
    22.605475,
    88.384658
  ],
  [
    22.605414,
    88.384671
  ],
  [
    22.605107,
    88.384692
  ],
  [
    22.604797,
    88.384754
  ],
  [
    22.604771,
    88.38477
  ],
  [
    22.6047,
    88.384755
  ],
  [
    22.604575,
    88.384734
  ],
  [
    22.604207,
    88.384594
  ],
  [
    22.604098,
    88.384515
  ],
  [
    22.603837,
    88.384436
  ],
  [
    22.603802,
    88.384728
  ],
  [
    22.603704,
    88.385028
  ],
  [
    22.603685,
    88.385076
  ],
  [
    22.603477,
    88.384985
  ],
  [
    22.602954,
    88.384687
  ],
  [
    22.602659,
    88.384563
  ],
  [
    22.602294,
    88.38438
  ],
  [
    22.602185,
    88.38453
  ],
  [
    22.601853,
    88.384994
  ],
  [
    22.601318,
    88.385915
  ],
  [
    22.601023,
    88.386535
  ],
  [
    22.600788,
    88.386964
  ],
  [
    22.600657,
    88.38728
  ],
  [
    22.600558,
    88.387574
  ],
  [
    22.60046,
    88.388078
  ],
  [
    22.600476,
    88.388287
  ],
  [
    22.600505,
    88.388359
  ],
  [
    22.600578,
    88.38842
  ],
  [
    22.600669,
    88.388459
  ],
  [
    22.600569,
    88.388767
  ],
  [
    22.600543,
    88.389651
  ],
  [
    22.600581,
    88.389895
  ],
  [
    22.600543,
    88.389651
  ],
  [
    22.600569,
    88.388767
  ],
  [
    22.600669,
    88.388459
  ],
  [
    22.600578,
    88.38842
  ],
  [
    22.600505,
    88.388359
  ],
  [
    22.600476,
    88.388287
  ],
  [
    22.60046,
    88.388078
  ],
  [
    22.600558,
    88.387574
  ],
  [
    22.600657,
    88.38728
  ],
  [
    22.600788,
    88.386964
  ],
  [
    22.601023,
    88.386535
  ],
  [
    22.601318,
    88.385915
  ],
  [
    22.601853,
    88.384994
  ],
  [
    22.602185,
    88.38453
  ],
  [
    22.602294,
    88.38438
  ],
  [
    22.602659,
    88.384563
  ],
  [
    22.602954,
    88.384687
  ],
  [
    22.603477,
    88.384985
  ],
  [
    22.603685,
    88.385076
  ],
  [
    22.603704,
    88.385028
  ],
  [
    22.603802,
    88.384728
  ],
  [
    22.603837,
    88.384436
  ],
  [
    22.604057,
    88.384275
  ],
  [
    22.604221,
    88.384186
  ],
  [
    22.604753,
    88.384106
  ],
  [
    22.605183,
    88.383893
  ],
  [
    22.605135,
    88.383755
  ],
  [
    22.605072,
    88.383543
  ],
  [
    22.604828,
    88.382739
  ],
  [
    22.604573,
    88.381829
  ],
  [
    22.604353,
    88.381138
  ],
  [
    22.604211,
    88.380713
  ],
  [
    22.603692,
    88.379311
  ],
  [
    22.603647,
    88.379179
  ],
  [
    22.603715,
    88.379114
  ],
  [
    22.603762,
    88.379159
  ],
  [
    22.603923,
    88.379622
  ],
  [
    22.60399,
    88.379796
  ],
  [
    22.604238,
    88.379844
  ],
  [
    22.604595,
    88.379932
  ],
  [
    22.604929,
    88.380036
  ],
  [
    22.60495,
    88.380029
  ],
  [
    22.604985,
    88.379986
  ],
  [
    22.60495,
    88.380029
  ],
  [
    22.604929,
    88.380036
  ],
  [
    22.604595,
    88.379932
  ],
  [
    22.604238,
    88.379844
  ],
  [
    22.60399,
    88.379796
  ],
  [
    22.603923,
    88.379622
  ],
  [
    22.603762,
    88.379159
  ],
  [
    22.603715,
    88.379114
  ],
  [
    22.603647,
    88.379179
  ],
  [
    22.603586,
    88.378949
  ],
  [
    22.603509,
    88.378687
  ],
  [
    22.603452,
    88.378495
  ],
  [
    22.603357,
    88.378181
  ],
  [
    22.6031,
    88.377354
  ],
  [
    22.60307,
    88.377249
  ],
  [
    22.602897,
    88.376731
  ],
  [
    22.602863,
    88.376628
  ],
  [
    22.602522,
    88.375636
  ],
  [
    22.601855,
    88.3737
  ],
  [
    22.60182,
    88.373686
  ],
  [
    22.601786,
    88.373618
  ],
  [
    22.60179,
    88.373593
  ],
  [
    22.601795,
    88.373579
  ],
  [
    22.601577,
    88.373284
  ],
  [
    22.601337,
    88.372387
  ],
  [
    22.601007,
    88.371332
  ],
  [
    22.600648,
    88.370066
  ],
  [
    22.600501,
    88.370086
  ],
  [
    22.600254,
    88.369656
  ],
  [
    22.59972,
    88.368805
  ],
  [
    22.599428,
    88.368311
  ],
  [
    22.599279,
    88.368053
  ],
  [
    22.599174,
    88.367869
  ],
  [
    22.59907,
    88.367716
  ],
  [
    22.598914,
    88.367417
  ],
  [
    22.59888,
    88.367377
  ],
  [
    22.598615,
    88.36706
  ],
  [
    22.598604,
    88.366624
  ],
  [
    22.598589,
    88.366387
  ],
  [
    22.598563,
    88.36608
  ],
  [
    22.598292,
    88.365994
  ],
  [
    22.597885,
    88.365852
  ],
  [
    22.597644,
    88.365768
  ],
  [
    22.59704,
    88.365518
  ],
  [
    22.596916,
    88.365456
  ],
  [
    22.59637,
    88.365275
  ],
  [
    22.596405,
    88.365142
  ],
  [
    22.596561,
    88.364517
  ],
  [
    22.596606,
    88.364386
  ],
  [
    22.596651,
    88.364258
  ],
  [
    22.59642,
    88.363645
  ],
  [
    22.596337,
    88.363464
  ],
  [
    22.596111,
    88.362905
  ],
  [
    22.595967,
    88.362482
  ],
  [
    22.595684,
    88.361739
  ],
  [
    22.595411,
    88.360957
  ],
  [
    22.595178,
    88.360291
  ],
  [
    22.595107,
    88.359999
  ],
  [
    22.595077,
    88.359877
  ],
  [
    22.595023,
    88.359825
  ],
  [
    22.594986,
    88.35964
  ],
  [
    22.595005,
    88.359578
  ],
  [
    22.594984,
    88.359492
  ],
  [
  ],
  [
    22.594727,
    88.357194
  ],
 [
    22.594681,
    88.357182
  ],
  [
    22.594334,
    88.357202
  ],
  [
    22.593918,
    88.357225
  ],
  [
    22.593555,
    88.357139
  ],
  [
    22.593373,
    88.357096
  ],
  [
    22.592836,
    88.356847
  ],
  [
    22.592285,
    88.356592
  ],
  [
    22.592271,
    88.356639
  ],
  [
    22.591692,
    88.356465
  ],
  [
    22.591643,
    88.356451
  ],
  [
    22.591236,
    88.356329
  ],
  [
    22.590804,
    88.356192
  ],
  [
    22.590444,
    88.356069
  ],
  [
    22.590042,
    88.355936
  ],
  [
    22.589142,
    88.355674
  ],
  [
    22.588357,
    88.355407
  ],
  [
    22.58793,
    88.355274
  ],
  [
    22.587806,
    88.355233
  ],
  [
    22.587128,
    88.355041
  ],
  [
    22.586782,
    88.354957
  ],
  [
    22.586763,
    88.355103
  ],
  [
    22.586269,
    88.355018
  ],
  [
    22.586219,
    88.355025
  ],
  [
    22.586044,
    88.355183
  ],
  [
    22.585991,
    88.355203
  ],
  [
    22.585785,
    88.355139
  ],
  [
    22.585508,
    88.355054
  ],
  [
    22.585242,
    88.354973
  ],
  [
    22.584947,
    88.354882
  ],
  [
    22.584829,
    88.354846
  ],
  [
    22.584528,
    88.354754
  ],
  [
    22.584321,
    88.354691
  ],
  [
    22.584229,
    88.354662
  ],
  [
    22.583795,
    88.354529
  ],
  [
    22.583915,
    88.354046
  ],
  [
    22.584003,
    88.353706
  ],
  [
    22.58408,
    88.353297
  ],
  [
    22.584171,
    88.352815
  ],
  [
    22.584322,
    88.352187
  ],
  [
    22.5834,
    88.351841
  ],
  [
    22.583052,
    88.35171
  ],
  [
    22.582577,
    88.351516
  ],
  [
    22.581858,
    88.351222
  ],
  [
    22.582305,
    88.349788
  ],
  [
    22.582662,
    88.349624
  ],
  [
    22.583236,
    88.349615
  ],
  [
    22.583659,
    88.349572
  ],
  [
    22.583838,
    88.349529
  ],
  [
    22.584001,
    88.349554
  ],
  [
    22.584167,
    88.349556
  ],
  [
    22.584304,
    88.349517
  ],
  [
    22.584484,
    88.349294
  ],
  [
    22.585621,
    88.344658
  ],
  [
    22.585672,
    88.344272
  ],
  [
    22.585645,
    88.344114
  ],
  [
    22.58556,
    88.343987
  ],
  [
    22.585423,
    88.343965
  ],
  [
    22.58522,
    88.34402
  ],
  [
    22.584801,
    88.344018
  ],
  [
    22.584598,
    88.343977
  ],
  [
    22.584513,
    88.343857
  ],
  [
    22.584455,
    88.343649
  ],
  [
    22.584455,
    88.343445
  ],
  [
    22.584533,
    88.3432
  ],
  [
    22.584716,
    88.34283
  ],
  [
    22.584812,
    88.342422
  ],
  [
    22.5849,
    88.342108
  ],
  [
    22.58491,
    88.342002
  ],
  [
    22.584943,
    88.341864
  ],
  [
    22.58525,
    88.341185
  ],
  [
    22.585436,
    88.340441
  ],
  [
    22.585756,
    88.339341
  ],
  [
    22.58603,
    88.339269
  ],
  [
    22.586314,
    88.339283
  ],
  [
    22.587122,
    88.339431
  ],
  [
    22.58734,
    88.339498
  ],
  [
    22.587737,
    88.339621
  ],
  [
    22.587835,
    88.339651
  ],
  [
    22.588138,
    88.339801
  ],
  [
    22.588694,
    88.340076
  ],
  [
    22.5892,
    88.340366
  ],
  [
    22.589521,
    88.340506
  ],
  [
    22.589552,
    88.340615
  ],
  [
    22.58948,
    88.341078
  ],
  [
    22.589334,
    88.341538
  ],
  [
    22.589203,
    88.341851
  ],
  [
    22.589004,
    88.342233
  ],
  [
    22.588917,
    88.342464
  ],
  [
    22.588828,
    88.342553
  ],
  [
    22.58873,
    88.342814
  ],
  [
    22.588595,
    88.343253
  ],
  [
    22.588392,
    88.344009
  ],
  [
    22.588388,
    88.344028
  ]
],
    speed: 15, // meters per second
    index: 0,
    distanceCovered: 0,
    current: null
  },
  {
    id: 3,
    name: "Ballygunge-Howrah Route",
    coords:  [
  [
    22.539534,
    88.352193 
  ],
  [
    22.540481,
    88.352316
  ],
  [
    22.541274,
    88.352399
  ],
  [
    22.541322,
    88.351563
  ],
  [
    22.541512,
    88.351589
  ],
  [
    22.54193,
    88.351714
  ],
  [
    22.542642,
    88.351926
  ],
  [
    22.543712,
    88.352195
  ],
  [
    22.543892,
    88.35224
  ],
  [
    22.545241,
    88.352627
  ],
  [
    22.546464,
    88.352981
  ],
  [
    22.546945,
    88.35312
  ],
  [
    22.547283,
    88.35321
  ],
  [
    22.547762,
    88.35334
  ],
  [
    22.547878,
    88.353372
  ],
  [
    22.548058,
    88.353415
  ],
  [
    22.54788,
    88.354394
  ],
  [
    22.550142,
    88.355009
  ],
  [
    22.549675,
    88.35583
  ],
  [
    22.549581,
    88.355994
  ],
  [
    22.54957,
    88.356028
  ],
  [
    22.549581,
    88.355994
  ],
  [
    22.549675,
    88.35583
  ],
  [
    22.550142,
    88.355009
  ],
  [
    22.551246,
    88.355509
  ],
  [
    22.551869,
    88.355783
  ],
  [
    22.552498,
    88.356065
  ],
  [
    22.553471,
    88.356514
  ],
  [
    22.554037,
    88.35678
  ],
  [
    22.554101,
    88.356794
  ],
  [
    22.554425,
    88.356864
  ],
  [
    22.555385,
    88.357071
  ],
  [
    22.556052,
    88.357204
  ],
  [
    22.556373,
    88.357261
  ],
  [
    22.557452,
    88.357493
  ],
  [
    22.557736,
    88.357542
  ],
  [
    22.558274,
    88.35765
  ],
  [
    22.558063,
    88.358518
  ],
  [
    22.558274,
    88.35765
  ],
  [
    22.55944,
    88.357934
  ],
  [
    22.559839,
    88.358046
  ],
  [
    22.560197,
    88.358146
  ],
  [
    22.561435,
    88.358402
  ],
  [
    22.562308,
    88.358595
  ],
  [
    22.562408,
    88.358624
  ],
  [
    22.562981,
    88.358703
  ],
  [
    22.563876,
    88.359026
  ],
  [
    22.564655,
    88.359295
  ],
  [
    22.564866,
    88.359381
  ],
  [
    22.565338,
    88.35955
  ],
  [
    22.566303,
    88.359899
  ],
  [
    22.566535,
    88.359972
  ],
  [
    22.566888,
    88.360064
  ],
  [
    22.566989,
    88.360091
  ],
  [
    22.567198,
    88.36013
  ],
  [
    22.567489,
    88.360182
  ],
  [
    22.568107,
    88.360258
  ],
  [
    22.568361,
    88.360302
  ],
  [
    22.568587,
    88.360316
  ],
  [
    22.569583,
    88.360748
  ],
  [
    22.569468,
    88.36109
  ],
  [
    22.569299,
    88.361594
  ],
  [
    22.569202,
    88.361883
  ],
  [
    22.569299,
    88.361594
  ],
  [
    22.569468,
    88.36109
  ],
  [
    22.569583,
    88.360748
  ],
  [
    22.569779,
    88.360144
  ],
  [
    22.570008,
    88.359435
  ],
  [
    22.570106,
    88.359135
  ],
  [
    22.57033,
    88.358445
  ],
  [
    22.570432,
    88.358131
  ],
  [
    22.570482,
    88.35797
  ],
  [
    22.571525,
    88.35832
  ],
  [
    22.571899,
    88.358445
  ],
  [
    22.572367,
    88.358602
  ],
  [
    22.572477,
    88.358643
  ],
  [
    22.573082,
    88.358867
  ],
  [
    22.573829,
    88.359117
  ],
  [
    22.574364,
    88.359283
  ],
  [
    22.574771,
    88.359416
  ],
  [
    22.575345,
    88.35961
  ],
  [
    22.575957,
    88.3598
  ],
  [
    22.576927,
    88.360106
  ],
  [
    22.576995,
    88.360124
  ],
  [
    22.577643,
    88.360295
  ],
  [
    22.578127,
    88.360469
  ],
  [
    22.578656,
    88.360653
  ],
  [
    22.57872,
    88.360531
  ],
  [
    22.578903,
    88.359837
  ],
  [
    22.579004,
    88.359468
  ],
  [
    22.579199,
    88.358746
  ],
  [
    22.579292,
    88.358187
  ],
  [
    22.579435,
    88.357726
  ],
  [
    22.579524,
    88.357444
  ],
  [
    22.57972,
    88.35682
  ],
  [
    22.579865,
    88.356523
  ],
  [
    22.580239,
    88.355716
  ],
  [
    22.580392,
    88.355322
  ],
  [
    22.580462,
    88.35513
  ],
  [
    22.580681,
    88.354482
  ],
  [
    22.580915,
    88.354082
  ],
  [
    22.581041,
    88.353761
  ],
  [
    22.581493,
    88.352347
  ],
  [
    22.581627,
    88.351964
  ],
  [
    22.581858,
    88.351222
  ],
  [
    22.582305,
    88.349788
  ],
  [
    22.582662,
    88.349624
  ],
  [
    22.583236,
    88.349615
  ],
  [
    22.583659,
    88.349572
  ],
  [
    22.583838,
    88.349529
  ],
  [
    22.584001,
    88.349554
  ],
  [
    22.584167,
    88.349556
  ],
  [
    22.584304,
    88.349517
  ],
  [
    22.584484,
    88.349294
  ],
  [
    22.585621,
    88.344658
  ],
  [
    22.585672,
    88.344272
  ],
  [
    22.585645,
    88.344114
  ],
  [
    22.58556,
    88.343987
  ],
  [
    22.585423,
    88.343965
  ],
  [
    22.58522,
    88.34402
  ],
  [
    22.585211,
    88.344074
  ],
  [
    22.585158,
    88.344127
  ],
  [
    22.584774,
    88.344189
  ],
  [
    22.584639,
    88.344184
  ],
  [
    22.584455,
    88.344112
  ],
  [
    22.584305,
    88.344059
  ],
  [
    22.583195,
    88.343532
  ],
  [
    22.583164,
    88.34361
  ],
  [
    22.584108,
    88.344074
  ],
  [
    22.584473,
    88.3443
  ],
  [
    22.584801,
    88.344453
  ],
  [
    22.584925,
    88.344486
  ],
  [
    22.584985,
    88.344484
  ],
  [
    22.585293,
    88.344392
  ],
  [
    22.585514,
    88.344349
  ],
  [
    22.585645,
    88.34437
  ],
  [
    22.585756,
    88.344429
  ],
  [
  ],
  [
    22.586203,
    88.344342
  ]
],
    speed: 25, // meters per second
    index: 0,
    distanceCovered: 0,
    current: null
  },
];

// Haversine distance in meters
function getDistance([lat1, lon1], [lat2, lon2]) {
  const R = 6371e3;
  const φ1 = lat1 * Math.PI / 180;
  const φ2 = lat2 * Math.PI / 180;
  const Δφ = (lat2 - lat1) * Math.PI / 180;
  const Δλ = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(Δφ / 2) ** 2 +
    Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

// Move buses smoothly with overshoot fix
function moveBuses() {
  const tickTime = 1; // seconds per interval (setInterval = 1000ms)

  busRoutes.forEach(bus => {
    if (!bus.current) bus.current = [...bus.coords[0]]; // initialize

    const next = bus.coords[bus.index + 1];
    if (next) {
      const [lat1, lon1] = bus.current;
      const [lat2, lon2] = next;

      const distance = getDistance([lat1, lon1], [lat2, lon2]);

      if (distance < 0.5) {
        // Close enough → move to next point
        bus.index++;
        bus.current = [...next];
      } else {
        // Fraction of segment to move this tick
        let fraction = (bus.speed * tickTime) / distance;

        // Cap fraction at 1 to avoid overshooting
        if (fraction > 1) fraction = 1;

        const stepLat = (lat2 - lat1) * fraction;
        const stepLon = (lon2 - lon1) * fraction;

        bus.current[0] += stepLat;
        bus.current[1] += stepLon;
        bus.distanceCovered += getDistance([lat1, lon1], bus.current);
      }
    }
  });

  // Emit bus positions to clients
  io.emit(
    'busUpdate',
    Object.fromEntries(
      busRoutes.map(bus => [
        bus.name,
        {
          lat: bus.current[0],
          lon: bus.current[1],
          speed: bus.speed,
          distance: bus.distanceCovered
        }
      ])
    )
  );
}

// Update buses every second
setInterval(moveBuses, 1000);

server.listen(3000, () => console.log('Server running on port 3000'));
